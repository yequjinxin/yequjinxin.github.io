<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="keywords" content="Gridea静态个人博客">
<meta name="description" content="你来时，花月正春风">
<meta name="theme-color" content="#000">
<title>MAZE</title>
<link rel="shortcut icon" href="/favicon.ico?v=1655998491100">
<link rel="stylesheet" href="/media/css/mist.css">
<link rel="stylesheet" href="/media/fonts/font-awesome.css">
<link
  href="//fonts.loli.net/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Rosario:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"
  rel="stylesheet" type="text/css">

<link href="/media/hljs/styles/default.css"
  rel="stylesheet">

<link rel="stylesheet" href="/styles/main.css">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/media/js/jquery.js"></script>
<script src="/media/hljs/highlight.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.0/velocity.ui.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
  integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
  integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
  integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
  onload="renderMathInElement(document.body);"></script>






  <meta name="description" content="你来时，花月正春风">
</head>

<body>
  <div class="head-top-line"></div>
  <div class="header-box">
    
<div class="mist">
  <header class="header bg-color ">
    <div class="blog-header box-shadow-wrapper  " id="header">
      <div class="nav-toggle" id="nav_toggle">
        <div class="toggle-box">
          <div class="line line-top"></div>
          <div class="line line-center"></div>
          <div class="line line-bottom"></div>
        </div>
      </div>
      <div class="site-meta">       
        <div class="site-title">
          
            <a href="/" class="">
              <span class="logo-line-before">
                <i class=""></i>
              </span>
              <span class="main-title">MAZE</span>
              <span class="logo-line-after">
                <i class=""></i>
              </span>
            </a>  
          
        </div>
        
      </div>
      <nav class="site-nav" id="site_nav">
        <ul id="nav_ul">
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/" target="_self">
                  <i class="fa fa-globe"></i> 首页
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item nav-item-active">
              
              
                <a href="/archives" target="_self">
                  <i class="fa fa-globe"></i> 归档
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/tags" target="_self">
                  <i class="fa fa-globe"></i> 标签
                </a>
              
            </li>
          
            
            
              
            
            <li class="nav-item ">
              
              
                <a href="/post/about" target="_self">
                  <i class="fa fa-globe"></i> 关于
                </a>
              
            </li>
          
          
            
              <li class="nav-item ">
                <a href="/friends/" target="_self">
                  
                    <i class="fa fa-address-book"></i> 友链
                  
                </a>
              </li>
            
          
          
            <li id="fa_search" class="nav-item">
              <a href="javascript:void(0);">
                <i class="fa fa-search"></i> <span class="language" data-lan="search">搜索</span>
              </a>
            </li>
          
        </ul>
      </nav>
    </div>
  </header>
</div>

<script type="text/javascript"> 
 
  let showNav = true;

  let navToggle = document.querySelector('#nav_toggle'),
  siteNav = document.querySelector('#site_nav');
  
  function navClick() {
    let sideBar = document.querySelector('.sidebar');
    let navUl = document.querySelector('#nav_ul');
    navToggle.classList.toggle('nav-toggle-active');
    siteNav.classList.toggle('nav-menu-active');
    if (siteNav.classList.contains('nav-menu-active')) {
      siteNav.style = "height: " + (navUl.children.length * 42) +"px !important";
    } else {
      siteNav.style = "";
    }
  }

  navToggle.addEventListener('click',navClick);  
</script>
  </div>
  <div class="main-continer">
    
    <div
      class="section-layout bg-color mist">
      <div class="section-layout-wrapper">
        <div id="sidebarMeta" class="sidebar">
    
<div class="sidebar-wrapper box-shadow-wrapper ">
  <div class="sidebar-item">
    <img class="site-author-image right-motion" src="/images/avatar.png"/>
    <p class="site-author-name">MAZE</p>
    
  </div>
  <div class="sidebar-item side-item-stat right-motion">
    <div class="sidebar-item-box">
      <a href="/archives/">
        
        <span class="site-item-stat-count">2</span>
        <span class="site-item-stat-name language" data-lan="article">文章</span>
      </a>
    </div>
    <div class="sidebar-item-box">
      <a href="/tags/">
        <span class="site-item-stat-count">0</span>
        <span class="site-item-stat-name language" data-lan="tag">标签</span>
      </a>
    </div>
  </div>
  
  



</div>
</div>
<script>
  let sidebarMeta = document.querySelector('#sidebarMeta');
  let scheme = 'mist';
  let sidebarWrapper = document.querySelector('.sidebar-wrapper');
  if (sidebarMeta && (scheme === 'pisces' || scheme === 'gemini')) {
    document.addEventListener('scroll', function(e) {
      if (document.scrollingElement.scrollTop > parseInt(sidebarMeta.style.marginTop) + 10) {
        sidebarWrapper.classList.add('home-sidebar-fixed')
      } else {
        sidebarWrapper.classList.remove('home-sidebar-fixed')
      }
    });
  }
  </script>
        <div class="section-box box-shadow-wrapper">
          <section class="section archives-section bg-color posts-expand">
            

<div class="bg-color">
  <div class="archive-timeline-box">
    <div class="archive-timeline-title">
      
        <h2 class="language" data-lan="archives" data-count="2">非常好！目前共计2篇文章，继续努力！</h2>
      
    </div>
    
      
      
        <div class="node-title">
          <h2 class="tag-year">2022</h2>
        </div>    
        
      
      <a href="https://yequjinxin.github.io/post/lian-jie-chi/">
        <div class="motion-warpper tag-archive-node">
          <div class="tag-node">
            <h1>
              06-23
              <small>db 连接池</small>
            </h1>
          </div>  
      </div>
      </a>
    
      
      
      <a href="https://yequjinxin.github.io/post/io-zhi-mysql/">
        <div class="motion-warpper tag-archive-node">
          <div class="tag-node">
            <h1>
              06-20
              <small>Mysql 索引</small>
            </h1>
          </div>  
      </div>
      </a>
    
  </div>
  
<div class="page bg-color">
  <ul class="pagination-ul">
    
    
      
        <li class="pagination-li pagination-active">
            <a href="/archives/page/../">
              1
            </a>
        </li>
      
    
    
  </ul>
</div>
</div>

          </section>
        </div>
      </div>
    </div>
    <div class="footer-box">
  <footer class="footer">
    <center id="runTimeBox">
      已运行:<span id="run_time"></span>
    </center>
    <span id="busuanzi_container_site_pv">浏览数:<span id="busuanzi_value_site_pv"></span> 次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">访客数:<span id="busuanzi_value_site_uv"></span> 人</span>

    <script>
      BirthDay = new Date('');
      if (BirthDay.getTime()) {
        function runTime() {
          str = "";
          today = new Date();
          timeold = today.getTime() - BirthDay.getTime();
          msPerDay = 24 * 60 * 60 * 1000;
          e_daysold = timeold / msPerDay;
          daysold = Math.floor(e_daysold);
          str += daysold + "天";
          return str;
        }
        setInterval(function () {
          $("#run_time").html(runTime());
        }, 1000);
      } else {
        document.querySelector('.footer').removeChild(document.querySelector('#runTimeBox'));
      }
    </script>
    <div class="poweredby">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
  </footer>
  
    
      <div class="drawer-box left" id="drawer_box">
        <span class="muse-line muse-line-first"></span>
        <span class="muse-line muse-line-middle"></span>
        <span class="muse-line muse-line-last"></span>
      </div>
      
        <div class="mist back-to-top" id="back_to_top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
        
                  
                        
</div>
<script>
  let sideBarOpen = "sidebar-open";
  let body = document.body;
  let back2Top = document.querySelector("#back_to_top"),
    back2TopText = document.querySelector("#back_to_top_text"),
    drawerBox = document.querySelector("#drawer_box"),
    rightSideBar = document.querySelector(".sidebar"),
    viewport = document.querySelector("body");

  function scrollAnimation(currentY, targetY) {
    let needScrollTop = targetY - currentY;
    let _currentY = currentY;
    setTimeout(() => {
      const dist = Math.ceil(needScrollTop / 10);
      _currentY += dist;
      window.scrollTo(_currentY, currentY);
      if (needScrollTop > 10 || needScrollTop < -10) {
        scrollAnimation(_currentY, targetY);
      } else {
        window.scrollTo(_currentY, targetY);
      }
    }, 1);
  }

  back2Top.addEventListener("click", function (e) {
    scrollAnimation(document.scrollingElement.scrollTop, 0);
    e.stopPropagation();
    return false;
  });

  window.addEventListener("scroll", function (e) {
    let percent =
      (document.scrollingElement.scrollTop /
        (document.scrollingElement.scrollHeight -
          document.scrollingElement.clientHeight)) *
      100;
    if (percent > 1 && !back2Top.classList.contains("back-top-active")) {
      back2Top.classList.add("back-top-active");
    }
    if (percent == 0) {
      back2Top.classList.remove("back-top-active");
    }
    if (back2TopText) {
      back2TopText.textContent = Math.floor(percent);
    }
  });

  let hasCacu = false;
  window.addEventListener("resize", function (e) {
    calcuHeight();
  });

  function calcuHeight() {
    // 动态调整站点概览高度
    if (
      (!hasCacu && back2Top.classList.contains("pisces")) ||
      back2Top.classList.contains("gemini")
    ) {
      let sideBar = document.querySelector(".sidebar");
      let navUl = document.querySelector("#site_nav");
      sideBar.style =
        "margin-top:" + (navUl.offsetHeight + navUl.offsetTop + 15) + "px;";
      hasCacu = true;
    }
  }
  calcuHeight();

  let open = false,
    MOTION_TIME = 300,
    RIGHT_MOVE_DIS = "320px";

  if (drawerBox) {
    let rightMotions = document.querySelectorAll(".right-motion");
    let right = drawerBox.classList.contains("right");

    let transitionDir = right
      ? "transition.slideRightIn"
      : "transition.slideLeftIn";

    let openProp, closeProp;
    if (right) {
      openProp = {
        paddingRight: RIGHT_MOVE_DIS,
      };
      closeProp = {
        paddingRight: "0px",
      };
    } else {
      openProp = {
        paddingLeft: RIGHT_MOVE_DIS,
      };
      closeProp = {
        paddingLeft: "0px",
      };
    }

    drawerBox.onclick = function () {
      open = !open;
      jQuery.Velocity(rightSideBar, "stop");
      jQuery.Velocity(viewport, "stop");
      jQuery.Velocity(rightMotions, "stop");
      if (open) {
        jQuery.Velocity(
          rightSideBar,
          {
            width: RIGHT_MOVE_DIS,
          },
          {
            duration: MOTION_TIME,
            begin: function () {
              jQuery.Velocity(rightMotions, transitionDir, {});
            },
          }
        );
        jQuery.Velocity(viewport, openProp, {
          duration: MOTION_TIME,
        });
      } else {
        jQuery.Velocity(
          rightSideBar,
          {
            width: "0px",
          },
          {
            duration: MOTION_TIME,
            begin: function () {
              jQuery.Velocity(rightMotions, {
                opacity: 0,
              });
            },
          }
        );
        jQuery.Velocity(viewport, closeProp, {
          duration: MOTION_TIME,
        });
      }
      for (let i = 0; i < drawerBox.children.length; i++) {
        drawerBox.children[i].classList.toggle("muse-line");
      }
      drawerBox.classList.toggle(sideBarOpen);
    };
  }

  // 链接跳转
  let newWindow = "false";
  if (newWindow === "true") {
    let links = document.querySelectorAll(".post-body a");
    links.forEach((item) => {
      if (!item.classList.contains("btn")) {
        item.setAttribute("target", "_blank");
      }
    });
  }

  let faSearch = document.querySelector("#fa_search");
  faSearch &&
    faSearch.addEventListener("click", function () {
      document.querySelector("#search_mask").style = "";
    });

  // 代码高亮
  hljs.initHighlightingOnLoad();

  // 离开当前页title变化
  var leaveTitle = "";
  var normal_title = document.title;
  if (leaveTitle) {
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState == "hidden") {
        normal_title = document.title;
        document.title = leaveTitle;
      } else {
        document.title = normal_title;
      }
    });
  }
</script>

<link rel="stylesheet" href="/media/css/jquery.fancybox.css" />
<script src="/media/js/jquery.fancybox.js"></script>

<script>
  let images = document.querySelectorAll(".section img");
  images.forEach((image) => {
    var parent = image.parentElement;
    var next = image.nextElementSibling;
    parent.removeChild(image);
    var aelem = document.createElement("a");
    aelem.href = image.src;
    aelem.dataset["fancybox"] = "images";
    aelem.dataset["rel"] = "fancybox-button";
    aelem.classList.add("fancybox");
    aelem.appendChild(image);
    parent.insertBefore(aelem, next);
  });
</script>
  </div>
</body>

  <div class="search-mask" id="search_mask" style="display: none;">
  <div class="search-box">
    <div class="search-title">
      <i class="fa fa-search"></i>
      <div class="input-box">
        <input id="search" type="text" class="language" data-lan="search" placeholder="搜索">
      </div>
      <i id="close" class="fa fa-times-circle"></i>
    </div>
    <div class="stat-box">
      <span id="stat_count">0</span><span class="language" data-lan="stat">条相关条目，使用了</span><span id="stat_times">0</span><span class="language" data-lan="stat-time">毫秒</span>
      <hr>
    </div>
    <div class="result" id="result">
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://yequjinxin.github.io/post/lian-jie-chi/"" data-c="
          &lt;p&gt;从&lt;strong&gt;连接和请求&lt;/strong&gt;的角度分析连接池。&lt;/p&gt;
&lt;h3 id=&#34;短链接&#34;&gt;短链接&lt;/h3&gt;
&lt;p&gt;连接:请求 = 1:1&lt;br&gt;
以 php 实现的系统为例，浏览器每向 Web Server 发起一次请求，php 都需要和 DB 建立一次连接。&lt;br&gt;
请求发起次数 = DB 建立连接次数&lt;/p&gt;
&lt;p&gt;每次请求都要建立连接，对于应用服务，有一个等待时间；对于 Mysql，有建立和销毁连接的系统开销。&lt;br&gt;
更大的问题在高并发场景下，Mysql 会达到连接上限，出现错误”too many connections“，应用系统就瘫痪了。&lt;/p&gt;
&lt;h3 id=&#34;长连接&#34;&gt;长连接&lt;/h3&gt;
&lt;p&gt;连接:请求 = n:1&lt;br&gt;
可以使用长链接（mysql_pconnect）解决 Mysql 的并发问题。&lt;/p&gt;
&lt;p&gt;在长连接下，php 的 worker 进程和 Mysql 进程间是持久连接，不存在瞬时大量创建销毁连接导致的问题。但是，这样又会引入一个新问题。&lt;/p&gt;
&lt;p&gt;为了满足高并发的压力，应用服务器采用负载均衡策略，我们以 20 台应用服务器举例，每台服务器 1000 个进程提供服务，这样就要建立 20000 的长连接。长连接等待数据的时间要远大于传输数据的时间，也就是说，这20000个长连接大部分时间都是处于闲置中（等待数据中），这对于 Mysql 资源是一种浪费。基于互联网应用的特点，只有 20% 的时间是繁忙的，这种做法也是不合理的。&lt;/p&gt;
&lt;h3 id=&#34;连接池&#34;&gt;连接池&lt;/h3&gt;
&lt;p&gt;连接:请求 = n:n&lt;br&gt;
既能提高系统效率，又能高并发，就需要采用连接池的方案。&lt;/p&gt;
&lt;p&gt;连接池（Connection Pool）技术的核心思想是：连接复用，通过建立一个数据库连接池以及一套连接使用、分配、管理策略，使得该连接池中的连接可以得到高效、安全的复用，避免了数据库连接频繁建立、关闭的开销。&lt;/p&gt;
&lt;p&gt;相较于php，go 语言自带连接池。我们这里以 go 语言示例，展示连接池的使用。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;淘宝的早期是 php 实现的，当时使用了一个第三方开源的数据库中间件，但是中间件存在问题并无法解决，这样全站就转到了 java 语言。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;示例&#34;&gt;示例&lt;/h4&gt;
&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;
db, _ := sql.Open(&amp;quot;mysql&amp;quot;, &amp;quot;root:root@tcp(127.0.0.1:3306)/blog?charset=utf8&amp;quot;) // Open 函数仅仅校验参数，并不会建立连接
db.SetMaxOpenConns(200) // 和 db 能建立的最大连接数，默认0，小于等于0不限制
db.SetMaxIdleConns(100) // 最大空闲连接数，默认2
db.SetConnMaxLifetime(60*time.Minute) // 连接可用的时间，过后连接失效
db.Ping()

db.Query(&amp;quot;SELECT * FROM blog_article limit 1&amp;quot;) // 从空闲池中获取连接，进行查询

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;db.Query 申请以及释放连接的一个流程图，如下&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://yequjinxin.github.io/post-images/1655998489339.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
">db 连接池</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://yequjinxin.github.io/post/io-zhi-mysql/"" data-c="
          &lt;p&gt;本文主要从磁盘 I/O 角度来分析索引。&lt;/p&gt;
&lt;h3 id=&#34;索引是什么&#34;&gt;索引是什么&lt;/h3&gt;
&lt;p&gt;索引可以理解成一本书的目录，通过目录快速定位查阅的内容页。是一种用空间换取时间的策略，加快查询速度的方式。索引和数据都存储在磁盘中，查询数据的过程是先找索引，再根据索引读取数据。&lt;/p&gt;
&lt;p&gt;没有创建索引（如果没有primary key 或 non-null unique 字段，InnoDB 会默认生成一个默认6-byte的隐藏自增键，这里指没有创建Secondary Index，&lt;a href=&#34;https://dev.mysql.com/doc/refman/5.7/en/innodb-index-types.html&#34;&gt;点击查看&lt;/a&gt;），我们需要从第一行数据开始，遍历整张表，寻找相关的行。在Clustered Index中，糟糕的情况下，我们需要读取所有的节点来查找用户记录。&lt;/p&gt;
&lt;p&gt;那么索引的结构是什么？&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;如果是二叉树&lt;/strong&gt;，会退化成链表，就又变成了全表遍历。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;如果是红黑树&lt;/strong&gt;（平衡二叉树），由于每个父节点只能存在两个子节点，记录数很大时，树的高度也会很大。其次，既然红黑树可以进行 rebalance，一个节点的改变会导致整棵树结构重建，这对于硬盘持久化存储是不可接受的。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;如果是B-Tree&lt;/strong&gt;（平衡多叉树），增加每个节点的索引值，也就是B-Tree的阶，从而降低了树的高度。&lt;br&gt;
同时，节点不过分依赖整体树结构，从而更加独立，这样在树结构更新时比二叉树更加高效。&lt;/p&gt;
&lt;!-- 但是非叶子节点会存储用户记录数据，这样会占用更多的空间，查询会导致更多I/O，以及在范围查找不能顺序获取用户记录数据。 --&gt;
&lt;p&gt;B-Tree 中的每个节点都包含 Key、Point、Data，这样导致的问题是，对于 DB 而言查找数据变得昂贵，一个固定大小的索引页如果包含了Data，能索引的值就变少，这样就需要更多的索引页，结果就是需要更多的I/O。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;如果是 B+Tree&lt;/strong&gt;，将节点分成了两种，叶子节点和非叶子节点（索引节点）&lt;br&gt;
叶子节点的记录行（data rows）和非叶子节点的索引值（key-pointer对）的个数理论上没有限制，但所有叶子节点到根节点的距离是一致的。&lt;br&gt;
为了方便范围查找，叶子节点会包含一个指向下一个叶子节点的指针，同时，叶子节点中的记录行（Record rows）也会包含一个指向下一个记录的指针。&lt;/p&gt;
&lt;p&gt;Mysql InnoDB 存储引擎使用的正是 B+Tree。&lt;/p&gt;
&lt;hr&gt;
&lt;h3 id=&#34;分表&#34;&gt;分表&lt;/h3&gt;
&lt;p&gt;基于我们上面对索引数据结构的分析，可以通过增加单页的记录行数（垂直分表）以及降低索引层级（水平分表）来降低I/O。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;垂直分表&lt;br&gt;
将一张宽表，分成几张窄表。&lt;br&gt;
一页只有16K，一条记录（最大65535byte）可能需要多个磁盘页的容量，最好是控制在半个磁盘页大小，也就是 8K，&lt;a href=&#34;https://dev.mysql.com/doc/refman/8.0/en/innodb-limits.html&#34;&gt;点击了解&lt;/a&gt;。即便如此，一页才能存储两条记录。我们可以通过降低一条记录长度，让一个磁盘页容纳更多的记录，以此来降低I/O。&lt;br&gt;
垂直分表代价就是某些查询需要多操作（读、写）一次。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;水平分表&lt;br&gt;
通过降低单表的数据量，来降低索引的层级，同时降低I/O。&lt;br&gt;
相比垂直分表，水平分表代价比较大，会引入系统复杂度。比如，非 shardingkey 查询需要做数据聚合，可以通过数据库中间件，或者采用 ES 等全文索引数据库。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h4 id=&#34;什么时候水平分表&#34;&gt;什么时候水平分表&lt;/h4&gt;
&lt;p&gt;InnoDB 存储引擎将所有的记录全部存储在固定大小节点中，我们通常叫做页，目前页默认大小为16KB，页由7个部分组成，&lt;a href=&#34;https://dev.mysql.com/doc/internals/en/innodb-page-structure.html&#34;&gt;点击了解 Mysql Page Structure&lt;/a&gt;。当有新的记录要插入到聚集索引中，InnoDb 会为后面的数据预留1/16的页空间，&lt;a href=&#34;https://dev.mysql.com/doc/refman/5.7/en/innodb-physical-structure.html&#34;&gt;点击了解&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;大多时候，B+Tree 中的节点都是一页，非叶子节点对应索引页，叶子节点对应数据页。&lt;/p&gt;
&lt;p&gt;我们假设每页有14K存储数据（除去页的头和尾占用，以及1/16预留），一条用户记录长度 1K，&lt;br&gt;
对于 16K 的页，索引Key的长度限制为 3072-byte，但是实际应用 Key 越短越好，我们以 bigint 8-byte 为例子，Pointer 以 6-byte 为例，key-pointer 对占用 14-byte。&lt;/p&gt;
&lt;p&gt;一个索引页包含的值的个数是&lt;br&gt;
14 * 1024 / 14 = 1024&lt;br&gt;
一个数据页包含的记录个数是&lt;br&gt;
14 * 1024 / 1024 = 14&lt;/p&gt;
&lt;p&gt;如果是二级的B-Tree，能够容纳 1024 * 14 = 14336&lt;br&gt;
如果是三级的B-Tree，能够容纳 1024 * 1024 * 14= 14680064&lt;br&gt;
如果是四级的B-Tree，就是百亿级别了&lt;/p&gt;
&lt;p&gt;实际应用中，具体环境可能有差异，比如，更改页大小，单条记录的长度很大（可以垂直分表），会导致读取树的层级和节点数量变化，但是为了让 Mysql 保持良好性能，单表数据上千万就可以考虑分表了。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;参考文章&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://sqlity.net/en/2445/b-plus-tree/&#34;&gt;B+Trees – How SQL Server Indexes are Stored on Disk&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
">Mysql 索引</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://yequjinxin.github.io/post/input-output-io/"" data-c="
          &lt;blockquote&gt;&lt;/blockquote&gt;
&lt;p&gt;In computing, input/output (I/O, or informally io or IO) is the communication between an information processing system, such as a computer, and the outside world, possibly a human or another information processing system. Inputs are the signals or data received by the system and outputs are the signals or data sent from it. The term can also be used as part of an action; to &amp;quot;perform I/O&amp;quot; is to perform an input or output operation.&lt;/p&gt;
&lt;p&gt;广义的讲，I/O 指计算机之间，计算机和人或外界所进行的通信。&lt;/p&gt;
&lt;p&gt;I/O 设备，指在计算机之间（路由器、交换机）、计算机和人之间（键盘、鼠标）或计算机和外界之间（磁盘、传感器）使用的硬件。&lt;/p&gt;
&lt;p&gt;但是，对于软件工程师而言，主要关注网络 I/O 和磁盘 I/O（进程通过网络或磁盘读取或写入数据）。&lt;br&gt;
例如：linux 系统由文件组成，文件可以进行读写，c 的标准库 stdio.h 提供了 I/O 的操作。&lt;/p&gt;
&lt;p&gt;I/O 优化，对我们系统的性能提升是有巨大意义的。&lt;/p&gt;
&lt;h3 id=&#34;io-模型&#34;&gt;I/O 模型&lt;/h3&gt;
&lt;p&gt;同步、异步是对程序执行过程的描述&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;!-- 这里举一个例子，在公司开会，在会议中发现会议室的投屏不能工作了，这时候会议发起人把运维叫过来维修，然后他又选择用黑板代替投屏进行会议，运维修好后再切回投屏，这样会议的处理方式就是”异步“的，如果等待运维把投屏修好再进行会议，那么这个会议的处理方式就是“同步”的。 --&gt;
&lt;p&gt;阻塞、非阻塞是对程序状态的描述&lt;/p&gt;
&lt;!-- 还是上面的例子，会议从开始到结束都是有效进行的，那么会议状态是非阻塞。如果参会人员都在等待投屏正常使用，不幸的是，到会议时间结束也没整好，那么这个会议就是阻塞的。老板看到后说，你们还想不想干了？老板不关心细节，他只知道这个这群人干等着啥也没干（会议状态是阻塞）。

可能有人会问，同步阻塞，异步非阻塞呗，不是的。同样同步也存在非阻塞，还是上面的例子，我们把投屏坏了换成另外的一个场景，就是会议一开始就遇到了一个棘手的问题，大家争论不休，开启头脑风暴模式，但一直到会议时间结束也没有解决，这是同步的非阻塞会议。 --&gt;
&lt;h4 id=&#34;减少-io&#34;&gt;减少 I/O&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;浏览器缓存，降低网络I/O&lt;/li&gt;
&lt;li&gt;CDN，降低网络I/O&lt;/li&gt;
&lt;li&gt;Redis 缓存，降低磁盘I/O&lt;/li&gt;
&lt;li&gt;Mysql 优化（添加缓存、分表等），降低磁盘I/O，&lt;a href=&#34;https://yequjinxin.github.io/post/io-zhi-mysql/&#34;&gt;点击查看&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;程序优化
&lt;ul&gt;
&lt;li&gt;避免冗余I/O，例如：api重复调用，sql重复查询（n+1模式），降低网络、磁盘I/O&lt;/li&gt;
&lt;li&gt;为多个路由文件以及多个配置文件生成缓存文件，降低磁盘I/O&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;多线程或多进程&lt;/p&gt;
">input / output (I/O)</a>
      </div>
      
      <div class="item">
        <a class="result-title" style="opacity: 0;" href="https://yequjinxin.github.io/post/about/"" data-c="
          &lt;p&gt;这个博客，会记录一些心得。&lt;/p&gt;
">关于</a>
      </div>
      
    </div>
    <div class="page">
      <div id="page_ul"></div>
    </div>
  </div>
</div>
<script>
  !function () {
    let searchMask = document.querySelector('#search_mask');
    let result = document.querySelector('#result');
    let items = document.querySelectorAll('.item');
    let searchBox = document.querySelector('#search');
    let statCount = document.querySelector('#stat_count');
    let statTimes = document.querySelector('#stat_times');
    let pageUl = document.querySelector('#page_ul');
    let close = document.querySelector('#close');
    
    close.addEventListener('click', function() {
      searchMask.style = 'display: none;'
    })

    let finds = [];
    let contents = [];
    let pageSize = 10;
    items.forEach(item => {
      let a = item.querySelector('a');
      contents.push({
        title: a.innerText,
        details: a.dataset.c,
        link: a.href
      })
      item.remove();
    })

    function insertStr(soure, start, count) {
      let newStr = soure.substr(start, count);
      return soure.slice(0, start) + '<em>' + newStr + '</em>' + soure.slice(start + count);
    }

    pageUl.addEventListener('click', function(event) {
      let target = event.target;
      if (target.__proto__ === HTMLSpanElement.prototype) {
        appendResults(parseInt(target.dataset.i));
      }
    })

    function appendResults(index) {
      let htmlResult = '';
      let start = index || 0;
      let end = Math.min(start + pageSize, finds.length);
      for (let i = start; i < end; i++) {
        const current = finds[i];
        let html = current.title;
        let sum = 0;
        let positions = current.positions;
        positions.forEach(position => {
          html = insertStr(html, position.start + sum, position.count);
          sum += 9;
        })
        htmlResult += `<div class="item"><a class="result-title" href="${current.link}">${html}</a></div>`;
      }
      result.innerHTML = htmlResult;
      pageUl.innerHTML = '';
      let count = finds.length / pageSize;
      let lis = '';
      if (start !== 0) {
        lis += `<span class="fa fa-angle-left" data-i='${start - 1}'></span>`;
      }
      for (let i = 0; i < count; i++) {
        lis += `<span class='${i === start?'current':''}' data-i='${i}'>${i+1}</span>`;     
      }
      if (start+1 < count) {
        lis += `<span class="fa fa-angle-right" data-i='${start+1}'></span>`;  
      }
      pageUl.innerHTML = lis;
    }

    function search(delay) {
      let timer = null
      return function () {
        clearTimeout(timer)
        timer = setTimeout(() => {
          let start = Date.now();
          let segments = searchBox.value.split(' ').filter(c => c != '');
          if (segments.length <= 0) {
            return;
          }
          finds = [];
          let htmlResult = '';
          contents.forEach(content => {
            let title = content.title;
            let positions = [];
            let find = false;
            segments.forEach((segment) => {
              if (content.title.includes(segment)) {
                find = true;
                positions.push({
                  start: content.title.indexOf(segment),
                  count: segment.length
                })
              } else if (content.details.includes(segment)) {
                find = true;
              }
            });
            if (find) {
              finds.push({
                title: content.title,
                link: content.link,
                positions
              });
            }
          })
          appendResults(0);
          statCount.textContent = finds.length;
          statTimes.textContent = Date.now() - start;
        }, delay)
      }
    }
    searchBox.addEventListener('input', search(200));
  }()
</script>

<input hidden id="copy" />
<script>
  !function () {
    let times = document.querySelectorAll('.publish-time');
    for (let i = 0; i < times.length; i++) {
      let date = times[i].dataset.t;
      let time = Math.floor((new Date().getTime() - new Date(date).getTime()) / 1000);
      if (time < 60) {
        str = time + '秒之前';
      } else if (time < 3600) {
        str = Math.floor(time / 60) + '分钟之前';
      } else if (time >= 3600 && time < 86400) {
        str = Math.floor(time / 3600) + '小时之前';
      } else if (time >= 86400 && time < 259200) {
        str = Math.floor(time / 86400) + '天之前';
      } else {
        str = times[i].textContent;
      }
      times[i].textContent = str;
    }
  }();
</script>

<script>
  let language = '';
  if (language !== '') {
    let map = new Map();
    if (language === 'en') {
      map.set('search', 'Search');
      map.set('category', 'Categories');
      map.set('article', 'Articles');
      map.set('tag', 'Tags');
      map.set('top', 'Top');
      map.set('publish', 'published');
      map.set('minute', ' minutes');
      map.set('read-more', 'Read More');
      map.set('view', 'View');
      map.set('words', ' words');
      map.set('category-in', 'category in');
      map.set('preview', 'Meta');
      map.set('index', 'Toc');
      map.set('no-archives', "You haven't created yet");
      map.set('archives', " articles in total");
      map.set('cloud-tags', " tags in total");
      map.set('copyright', "Copyright: ");
      map.set('author', "Author: ");
      map.set('link', "Link: ");
      map.set('leave-message', "Leave a message");
      map.set('format', "Links Format");
      map.set('site-name', "Name: ");
      map.set('site-link', "Link: ");
      map.set('site-desc', "Desc: ");
      map.set('stat', " related results, taking ");
      map.set('stat-time', " ms");
      map.set('site-img', "Image: ");
    }

    if (map.size > 0) {
      let lanElems = document.querySelectorAll('.language');
      lanElems.forEach(elem => {
        let lan = elem.dataset.lan, text = map.get(lan);
        if (elem.__proto__ === HTMLInputElement.prototype) {
          elem.placeholder = text
        } else {
          if (elem.dataset.count) {
            text = elem.dataset.count + text;
          }
          elem.textContent = text;
        }
      })
    }
  }

  window.Clipboard = (function (window, document, navigator) {
    var textArea,
      copy;

    // 判断是不是ios端
    function isOS() {
      return navigator.userAgent.match(/ipad|iphone/i);
    }
    //创建文本元素
    function createTextArea(text) {
      textArea = document.createElement('textArea');
      textArea.value = text;
      textArea.style.width = 0;
      textArea.style.height = 0;
      textArea.clientHeight = 0;
      textArea.clientWidth = 0;
      document.body.appendChild(textArea);
    }
    //选择内容
    function selectText() {
      var range,
        selection;

      if (isOS()) {
        range = document.createRange();
        range.selectNodeContents(textArea);
        selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        textArea.setSelectionRange(0, 999999);
      } else {
        textArea.select();
      }
    }

    //复制到剪贴板
    function copyToClipboard() {
      try {
        document.execCommand("Copy")
      } catch (err) {
        alert("复制错误！请手动复制！")
      }
      document.body.removeChild(textArea);
    }

    copy = function (text) {
      createTextArea(text);
      selectText();
      copyToClipboard();
    };

    return {
      copy: copy
    };
  })(window, document, navigator);

  function copyCode(e) {
    if (e.srcElement.tagName === 'SPAN' && e.srcElement.classList.contains('copy-code')) {
      let code = e.currentTarget.querySelector('code');
      var text = code.innerText;
      if (e.srcElement.textContent === '复制成功') {
        return;
      }
      e.srcElement.textContent = '复制成功';
      (function (elem) {
        setTimeout(() => {
          if (elem.textContent === '复制成功') {
            elem.textContent = '复制代码'
          }
        }, 1000);
      })(e.srcElement)
      Clipboard.copy(text);
    }
  }

  let pres = document.querySelectorAll('pre');
  pres.forEach(pre => {
    let code = pre.querySelector('code');
    let copyElem = document.createElement('span');
    copyElem.classList.add('copy-code');
    copyElem.textContent = '复制代码';
    pre.appendChild(copyElem);
    pre.onclick = copyCode
  })

</script>
<script src="/media/js/motion.js"></script>


  <script
    src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>
  <script>
    var scroll = new SmoothScroll('a[href*="#"]', {
      speed: 200
    });
  </script>







</html>